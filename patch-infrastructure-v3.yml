# Patch for infrastructure-setup-v3.yml
# Add this section BEFORE the target group creation

# Check if target groups already exist
BACKEND_TG_EXISTS=$(aws elbv2 describe-target-groups \
  --names ${ENV_NAME}-backend-tg-80 \
  --query 'TargetGroups[0].TargetGroupArn' \
  --output text 2>/dev/null || echo "NOT_FOUND")

if [ "$BACKEND_TG_EXISTS" != "NOT_FOUND" ]; then
  echo "Found existing backend target group. Updating health check settings..."
  
  # Update health check settings instead of recreating
  aws elbv2 modify-target-group \
    --target-group-arn $BACKEND_TG_EXISTS \
    --health-check-path /api/actuator/health \
    --health-check-interval-seconds 45 \
    --health-check-timeout-seconds 30 \
    --unhealthy-threshold-count 5 \
    --healthy-threshold-count 2
  
  BACKEND_TG_ARN=$BACKEND_TG_EXISTS
  echo "Backend target group health check settings updated."
else
  echo "Creating new backend target group..."
  # Original target group creation code here
  BACKEND_TG_ARN=$(aws elbv2 create-target-group \
    --name ${ENV_NAME}-backend-tg-80 \
    --protocol HTTP \
    --port 8082 \
    --vpc-id ${VPC_ID} \
    --target-type ip \
    --health-check-path /api/actuator/health \
    --health-check-interval-seconds 45 \
    --health-check-timeout-seconds 30 \
    --healthy-threshold-count 2 \
    --unhealthy-threshold-count 5 \
    --query 'TargetGroups[0].TargetGroupArn' \
    --output text)
fi